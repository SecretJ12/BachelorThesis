
\section{Higher Order functions} \label{chapter:higher_order}

The goal of this chapter is to extends the schema so for for higher order functions.
First take a look at the function $\texttt{test}$.
\begin{lstlisting}[language=isabelle,mathescape=true]
  fun test :: "(nat => bool) => nat => nat" where
    "test f a = (if f a then 1 else 0)"
\end{lstlisting}
Applying the translation for first order functions yields the following expression.
\begin{lstlisting}[language=isabelle,mathescape=true]
  T_f a + (if f a then 0 else 0)
\end{lstlisting}

This example shows that we need a way to address the original function as well as the timing function.
As we cannot generate the timing function dynamically Sands proposes to change every function argument by an pair \parencite{sands}.
First element is the original function (referenced by $\texttt{fun}$) second is the timing function (referenced by $\texttt{time}$).
Using this idea we can already convert the whole function.
\begin{lstlisting}[language=isabelle,mathescape=true]
  fun T_test :: "('a => bool) => 'a => nat" where
    "T_test f a = 1 + snd f a + (if fst f a then 1 else 0)"
\end{lstlisting}
Loosely spoken we need to use $\texttt{snd}$ everywhere the timing function is needed and $\texttt{fst}$ in case of a normal evaluation.
In order to formalize this Sand uses two distinct functions.
He uses them to convert every function $\texttt{f}$ into function $\texttt{f'}$ evaluating to the same result but with the described instead of function as input and the cost function $\texttt{cf}$.
\begin{figure}
  \begin{align*}
  f'\ x_{1}\ \dots\ x_{n} &= \mathcal{V}\llbracket e \rrbracket \\
  cf\ x_{1}\ \dots\ x_{n} &= 1 + \mathcal{N}o\mathcal{V}\llbracket e \rrbracket
  \end{align*}
  \caption{Translation schema for higher order function definitions}
\end{figure}

The function $\mathcal{V}$ replaces every function identifier by the described pair.
Therefore it makes shure that every function will be called with the expected pair.
For every application the function $\texttt{fun}$ is used.
Therefore the whole expression evaluates to the same result as the original expression.
The schema is described in figure \ref{fig:higher_V}.
In the next step is the function $\texttt{T}$ is applied.
Here the function $\texttt{time}$ is used in every application to get the timing function.
The schema is written in schema \ref{fig:higher_T}.
\begin{figure}
  \begin{align*}
    \mathcal{V}\llbracket f\ a_{1}\ \dots\ a_{n}\rrbracket &= f'\ \mathcal{V}\llbracket a_{1}\rrbracket\ \dots \ \mathcal{V}\llbracket a_{n}\rrbracket\\
    \mathcal{V}\llbracket p\ a_{1}\ \dots\ a_{n}\rrbracket &= p\ \mathcal{V}\llbracket a_{1}\rrbracket\ \dots \ \mathcal{V}\llbracket a_{n}\rrbracket\\
    \mathcal{V}\llbracket c \rrbracket &= c\\
    \mathcal{V}\llbracket \text{IF}\ c\ \text{THEN}\ e_{1}\ \text{ELSE}\ e_{2}\rrbracket &= \text{IF}\  \mathcal{V}\llbracket e_{1}\rrbracket\ \text{THEN}\ \mathcal{V}\llbracket e_{2}\rrbracket\ \text{ELSE}\ \mathcal{V}\llbracket e_{2}\rrbracket\\
    \mathcal{V}\llbracket f\rrbracket &= (f',cf)\\
    \mathcal{V}\llbracket p\rrbracket &= (p,cp)\\
    \mathcal{V}\llbracket e\ a_{1}\ \dots\ a_{n}\rrbracket &= \texttt{fun}\ \mathcal{V}\llbracket e\rrbracket\ \mathcal{V}\llbracket a_{1} \rrbracket\ \dots\ \mathcal{V}\llbracket a_{n}\rrbracket
  \end{align*}
  \caption{Translation schema V for higher order functions}
  \label{fig:higher_V}
\end{figure}
\begin{figure}
  \begin{align*}
    \mathcal{T}\llbracket f'\ a_{1}\ \dots\ a_{n}\rrbracket &= \mathcal{T}\llbracket a_{1}\rrbracket + \dots + \mathcal{T}\llbracket a_{n}\rrbracket + cf\ a_{1}\ \dots\ a_{n}\\
    \mathcal{T}\llbracket p\ a_{1}\ \dots\ a_{n}\rrbracket &= \mathcal{T}\llbracket a_{1}\rrbracket + \dots + \mathcal{T}\llbracket a_{n}\rrbracket\\
    \mathcal{T}\llbracket c \rrbracket &= 0\\
    \mathcal{T}\llbracket \text{IF}\ c\ \text{THEN}\ e_{1}\ \text{ELSE}\ e_{2}\rrbracket &= \mathcal{T}\llbracket c\rrbracket + \text{IF}\  c\ \text{THEN}\ \mathcal{V}\llbracket e_{1}\rrbracket\ \text{ELSE}\ \mathcal{T}\llbracket e_{2}\rrbracket\\
    \mathcal{T}\llbracket\texttt{fun}\ e\ a_{1}\ \dots\ a_{n}\rrbracket &= \mathcal{T}\llbracket e\rrbracket + \mathcal{T}\llbracket e_{1}\rrbracket + \dots + \mathcal{T}\llbracket e_{n}\rrbracket + \texttt{cost}\ e\ e_{1}\ \dots\ e_{n}\\
    \mathcal{T}\llbracket (f',cf)\rrbracket &= 0\\
    \mathcal{T}\llbracket (p,cp)\rrbracket &= 0
  \end{align*}
  \caption{Translation T for higher order functions}
  \label{fig:higher_T}
\end{figure}

\#TODO compare to Nipkow schema.
